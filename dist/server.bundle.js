(()=>{"use strict";const e=require("express"),r=require("dotenv"),t=(require("colors"),require("cors")),n=require("@babel/runtime/helpers/asyncToGenerator"),a=require("@babel/runtime/regenerator"),s=require("jsonwebtoken"),i=require("express-async-handler"),u=require("mongoose");var o=u.Schema({name:{type:String,required:[!0,"Please add a name"]},email:{type:String,required:[!0,"Please add an email"],unique:!0},password:{type:String,require:[!0,"Please add a password"]}},{timestamps:!0});const c=u.model("User",o);var d=i(function(){var e=n(a.mark((function e(r,t,n){var i,u;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.headers.authorization||!r.headers.authorization.startsWith("Bearer")){e.next=15;break}return e.prev=1,i=r.headers.authorization.split(" ")[1],u=s.verify(i,process.env.JWT_SECRET),e.next=6,c.findById(u.id).select("-password");case 6:r.user=e.sent,n(),e.next=15;break;case 10:throw e.prev=10,e.t0=e.catch(1),t.status(401),new Error("Not authorized");case 15:if(i){e.next=18;break}throw t.status(401),new Error("Not authorized, no token");case 18:case"end":return e.stop()}}),e,null,[[1,10]])})));return function(r,t,n){return e.apply(this,arguments)}}()),p=u.Schema({user:{type:u.Schema.Types.ObjectId,required:!0,ref:"User"},name:{type:String,required:[!0,"Please add a name"]},category:{type:String,required:[!0,"Please add a category"]},quantity:{type:Number,required:!1},unitPrice:{type:Number,required:!1},SKU:{type:String,unique:!0,required:!1},description:{type:String,required:!1}},{timestamps:!0});const f=u.model("Item",p);var m=i(function(){var e=n(a.mark((function e(r,t){var n;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,f.find();case 3:n=e.sent,t.status(200).json(n),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),t.status(500).json({message:"Server error getting items"});case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(r,t){return e.apply(this,arguments)}}()),l=i(function(){var e=n(a.mark((function e(r,t){var n;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r.body.name){e.next=4;break}throw t.status(400),new Error("Please add a name");case 4:return e.next=6,f.create({name:r.body.name,quantity:r.body.quantity,unitPrice:r.body.unitPrice,SKU:r.body.SKU,description:r.body.description,user:r.user.id});case 6:n=e.sent,t.status(200).json(n),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),t.status(500).json({message:"Server error creating item"});case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(r,t){return e.apply(this,arguments)}}()),v=i(function(){var e=n(a.mark((function e(r,t){var n,s;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,f.findById(r.params.id);case 3:if(n=e.sent){e.next=7;break}throw t.status(404),new Error("Item not found");case 7:if(n.user.toString()===r.user.id){e.next=10;break}throw t.status(403),new Error("User not authorized to update this item");case 10:return e.next=12,f.findByIdAndUpdate(r.params.id,r.body,{new:!0,runValidators:!0});case 12:s=e.sent,t.status(200).json(s),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(0),t.status(500).json({message:"Server error updating item"});case 20:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(r,t){return e.apply(this,arguments)}}()),h=i(function(){var e=n(a.mark((function e(r,t){var n;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,f.findByIdAndDelete(r.params.id);case 3:if(n=e.sent){e.next=7;break}throw t.status(400),new Error("Item not found");case 7:if(r.user){e.next=10;break}throw t.status(401),new Error("Not Authorized");case 10:if(n.user.toString()===r.user.id){e.next=13;break}throw t.status(401),new Error("User not authorized");case 13:t.status(200).json({message:"Item deleted ".concat(r.params.id)}),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(0),t.status(500).json({message:"Server error deleting item"});case 20:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(r,t){return e.apply(this,arguments)}}()),w=e.Router();w.route("/").get(m).post(d,l),w.route("/:id").put(d,v).delete(d,h);const x=w,y=require("bcryptjs");var b=i(function(){var e=n(a.mark((function e(r,t){var n,s,i,u,o,d,p,f;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.body,s=n.name,i=n.email,u=n.password,s&&i&&u){e.next=4;break}throw t.status(400),new Error("Please add all the fields");case 4:return e.next=6,c.findOne({email:i});case 6:if(!e.sent){e.next=10;break}throw t.status(400),new Error("User already exists");case 10:return e.next=12,y.genSalt(10);case 12:return o=e.sent,e.next=15,y.hash(u,o);case 15:return d=e.sent,e.next=18,c.create({name:s,email:i,password:d});case 18:if(!(p=e.sent)){e.next=24;break}f=q(p._id),t.status(201).json({_id:p.id,name:p.name,email:p.email,token:f}),e.next=26;break;case 24:throw t.status(400),new Error("Invalid user data");case 26:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}()),k=i(function(){var e=n(a.mark((function e(r,t){var n,s,i,u;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.body,s=n.email,i=n.password,e.next=3,c.findOne({email:s});case 3:if(u=e.sent,e.t0=u,!e.t0){e.next=9;break}return e.next=8,y.compare(i,u.password);case 8:e.t0=e.sent;case 9:if(!e.t0){e.next=13;break}t.status(200).json({_id:u.id,name:u.name,email:u.email,token:q(u._id)}),e.next=15;break;case 13:throw t.status(400),new Error("Invalid login credentials");case 15:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}()),g=i(function(){var e=n(a.mark((function e(r,t){var n,s,i,u;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.findById(r.user.id);case 2:n=e.sent,s=n._id,i=n.name,u=n.email,t.status(200).json({id:s,name:i,email:u});case 7:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}()),q=function(e){return s.sign({id:e},process.env.JWT_SECRET,{expiresIn:"1d"})},S=e.Router();S.route("/").post(b),S.route("/login").post(k),S.route("/me").get(d,g);const j=S;var E=function(){var e=n(a.mark((function e(){return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u.connect(process.env.MONGO_URI);case 3:e.sent,e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),process.exit(1);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(){return e.apply(this,arguments)}}();r.config();var I=process.env.PORT||8e3;E();var P=e();P.use(t()),P.use(e.json()),P.use(e.urlencoded({extended:!1})),P.use("/api/items",x),P.use("/api/users",j),P.use((function(e,r,t,n){var a=t.statusCode?t.statusCode:500;t.status(a),t.json({message:e.message,stack:null})})),P.listen(I,(function(){}))})();
//# sourceMappingURL=server.bundle.js.map